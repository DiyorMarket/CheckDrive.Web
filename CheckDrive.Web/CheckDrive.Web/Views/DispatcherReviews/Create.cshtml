@model CheckDrive.ApiContracts.DispatcherReview.DispatcherReviewForCreateDto

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_PersonalLayout.cshtml";
    double fuelSpend = Model.FuelSpended;
}

<div class="row mt-custom">
    <div class="col-md-4 offset-md-1 mt-5">
        <h4>Ro'yxatga olish</h4>
        <hr class="w-50" />
        <form asp-action="Create" method="post" id="createForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group w-50">
                <label asp-for="ChangedDistanceCovered" class="control-label">Bosib otilgan masofa</label>
                <input asp-for="ChangedDistanceCovered"
                       id="changedDistanceCovered"
                       class="form-control"
                       type="number"
                       value="@Html.Raw(Model.ChangedDistanceCovered != null ? Model.ChangedDistanceCovered : Model.DistanceCovered)" />
                <span asp-validation-for="ChangedDistanceCovered" class="text-danger"></span>
            </div>
            <div class="form-group w-50">
                <label class="control-label">Avtomobil bakidagi yoqilg`i miqdori</label>
                <input type="text" class="form-control" value="@ViewBag.FuelRemaining" disabled />
                <input type="hidden" id="FuelRemaining" name="FuelRemaining" value="@ViewBag.FuelRemaining" />
            </div>
            <div class="form-group w-50">
                <label asp-for="ChangedFuelSpendede" class="control-label">Sariflangan yoqilgi</label>
                <input asp-for="ChangedFuelSpendede"
                       id="changedFuelSpendede"
                       class="form-control"
                       type="number"
                       step="any"
                       value="@((Model.DistanceCovered * (ViewBag.MediumFuelConsumption ?? 0) / 100).ToString("F3"))" />
                <span asp-validation-for="ChangedFuelSpendede" class="text-danger"></span>
            </div>
            <div class="form-group w-50 mt-3">
                <label asp-for="Comment" for="exampleFormControlTextarea1">Izoh</label>
                <textarea asp-for="Comment" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group w-50">
                <input asp-for="DistanceCovered" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input type="hidden" name="FuelSpended" value="@((Model.DistanceCovered * (ViewBag.MediumFuelConsumption ?? 0) / 100).ToString("F3"))" />
            </div>
            <div class="form-group w-50">
                <input asp-for="Date" type="hidden" id="hiddenDate" />
            </div>
            <div class="form-group w-50">
                <input asp-for="DispatcherId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="OperatorId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="MechanicId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="DriverId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="CarId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="MechanicHandoverId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="MechanicAcceptanceId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="OperatorReviewId" type="hidden" />
            </div>
            <div class="form-group mt-3 w-50">
                <a asp-action="PersonalIndex" class="btn btn-outline-info">
                    <i class="fa-solid fa-arrow-left-long"></i> Orqaga
                </a>
                <button class="btn btn-outline-success" type="submit">
                    <i class="fa fa-plus"></i> Yaratish
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="validationErrorModal" tabindex="-1" role="dialog" aria-labelledby="validationErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationErrorModalLabel">Xatolik</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="validationErrorMessage">
                <!-- Здесь будет сообщение об ошибке -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('createForm').addEventListener('submit', function (event) {
            var currentDate = new Date().toISOString();

            var changedDistanceCoveredInput = document.querySelector('[name="ChangedDistanceCovered"]');
            var changedDistanceCovered = parseFloat(changedDistanceCoveredInput.value);
            var distanceCovered = parseFloat(document.querySelector('[name="DistanceCovered"]').value);

            var changedFuelSpendedeInput = document.querySelector('[name="ChangedFuelSpendede"]');
            var changedFuelSpendede = parseFloat(changedFuelSpendedeInput.value);
            var fuelSpended = parseFloat(document.querySelector('[name="FuelSpended"]').value);

            var fuelRemaining = parseFloat('@ViewBag.FuelRemaining') || 0;
            var commentField = document.querySelector('[name="Comment"]');
            var errorMessage = '';

            var originalDistanceCovered = '@Model.DistanceCovered';

            if (changedDistanceCovered === distanceCovered) {
                changedDistanceCoveredInput.value = '';
            }

            if (Math.abs(changedFuelSpendede - fuelSpended) < 0.01) {
                changedFuelSpendedeInput.value = '';
            }

            // Валидация
            if (changedDistanceCovered !== distanceCovered && commentField.value.trim() === '') {
                errorMessage = "Izoh kiritishingiz shart, chunki siz boshqa qiymat kiritdingiz!";
            }

            if (changedFuelSpendede > fuelRemaining) {
                if (commentField.value.trim() === '') {
                    errorMessage = "Sariflangan yoqilgi qiymati avtomobil bakidagi yoqilg'i miqdoridan katta bo'lishi mumkin emas. Iltimos, izoh kiriting.";
                    changedDistanceCoveredInput.value = originalDistanceCovered;
                }
            }

            if (errorMessage) {
                // Останавливаем отправку формы
                event.preventDefault();

                // Сохраняем значения, чтобы не сбрасывались
                document.getElementById('validationErrorMessage').textContent = errorMessage;
                var validationErrorModal = new bootstrap.Modal(document.getElementById('validationErrorModal'));
                validationErrorModal.show();
            } else {
                // Устанавливаем дату только если нет ошибок
                document.getElementById('hiddenDate').value = currentDate;
            }
        });

        // Не сбрасывать значения
        document.getElementById('changedDistanceCovered').addEventListener('input', function () {
            var distanceCovered = parseFloat(this.value) || 0;
            var mediumFuelConsumption = parseFloat('@ViewBag.MediumFuelConsumption.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)') || 0;

            var fuelSpended = (distanceCovered * mediumFuelConsumption) / 100;
            document.getElementById('changedFuelSpendede').value = fuelSpended.toFixed(3);
        });

        window.onload = function () {
            var distanceCovered = parseFloat(document.getElementById('changedDistanceCovered').value) || 0;
            var mediumFuelConsumption = parseFloat('@ViewBag.MediumFuelConsumption.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)') || 0;

            var initialFuelSpended = (distanceCovered * mediumFuelConsumption) / 100;
            document.getElementById('changedFuelSpendede').value = initialFuelSpended.toFixed(3);
        };
    </script>
}