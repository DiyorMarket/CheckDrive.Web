@model CheckDrive.ApiContracts.DispatcherReview.DispatcherReviewForCreateDto

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_PersonalLayout.cshtml";
    double fuelSpend = Model.FuelSpended;
    var dis = "sas";
}

<div class="row mt-custom">
    <div class="col-md-4 offset-md-1 mt-5">
        <h4>Ro'yxatga olish</h4>
        <hr class="w-50" />
        <form asp-action="Create" method="post" id="createForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group w-50">
                <label asp-for="ChangedDistanceCovered" class="control-label">Bosib otilgan masofa</label>
                <input asp-for="ChangedDistanceCovered" id="changedDistanceCovered" class="form-control" type="number" value="@Model.DistanceCovered" />
                <span asp-validation-for="ChangedDistanceCovered" class="text-danger"></span>
            </div>
            <div class="form-group w-50">
                <label class="control-label">Avtomobil bakidagi yoqilg`i miqdori</label>
                <input type="text" class="form-control" value="@ViewBag.FuelRemaining" disabled />
                <input type="hidden" id="FuelRemaining" name="FuelRemaining" value="@ViewBag.FuelRemaining" />
            </div>
            <div class="form-group w-50">
                <label asp-for="ChangedFuelSpendede" class="control-label">Sariflangan yoqilgi</label>
                <input asp-for="ChangedFuelSpendede"
                       id="changedFuelSpendede"
                       class="form-control"
                       type="number"
                       step="any"
                       value="@((Model.DistanceCovered * (ViewBag.MediumFuelConsumption ?? 0) / 100).ToString("F2"))" />
                <span asp-validation-for="ChangedFuelSpendede" class="text-danger"></span>
            </div>
            <div class="form-group w-50 mt-3">
                <label asp-for="Comment" for="exampleFormControlTextarea1">Izoh</label>
                <textarea asp-for="Comment" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group w-50">
                <input asp-for="DistanceCovered" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input type="hidden" name="FuelSpended" value="@((Model.DistanceCovered * (ViewBag.MediumFuelConsumption ?? 0) / 100).ToString("F2"))" />
            </div>
            <div class="form-group w-50">
                <input asp-for="Date" type="hidden" id="hiddenDate" />
            </div>
            <div class="form-group w-50">
                <input asp-for="DispatcherId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="OperatorId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="MechanicId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="DriverId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="CarId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="MechanicHandoverId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="MechanicAcceptanceId" type="hidden" />
            </div>
            <div class="form-group w-50">
                <input asp-for="OperatorReviewId" type="hidden" />
            </div>
            <div class="form-group mt-3 w-50">
                <a asp-action="PersonalIndex" class="btn btn-outline-info">
                    <i class="fa-solid fa-arrow-left-long"></i> Orqaga
                </a>
                <button class="btn btn-outline-success" type="submit">
                    <i class="fa fa-plus"></i> Yaratish
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('createForm').addEventListener('submit', function (event) {
            var currentDate = new Date().toISOString();

            var changedDistanceCovered = parseFloat(document.querySelector('[name="ChangedDistanceCovered"]').value);
            var distanceCovered = parseFloat(document.querySelector('[name="DistanceCovered"]').value);

            var changedFuelSpendede = parseFloat(document.querySelector('[name="ChangedFuelSpendede"]').value);
            var fuelSpended = parseFloat(document.querySelector('[name="FuelSpended"]').value);

            if (changedDistanceCovered === distanceCovered) {
                document.querySelector('[name="ChangedDistanceCovered"]').value = '';
            }

            if (Math.abs(changedFuelSpendede - fuelSpended) < 0.01) {
                document.querySelector('[name="ChangedFuelSpendede"]').value = '';
            }

            document.getElementById('hiddenDate').value = currentDate;

            // Ensure Comment is mandatory when distances don't match
            if (changedDistanceCovered !== distanceCovered) {
                var commentField = document.querySelector('[name="Comment"]');
                if (commentField.value.trim() === '') {
                    alert("Izoh (Comment) field is required when the distance covered values are different.");
                    commentField.focus();
                    event.preventDefault();
                }
            }
        });

        document.getElementById('changedDistanceCovered').addEventListener('input', function () {
            var distanceCovered = parseFloat(this.value) || 0;
            var mediumFuelConsumption = parseFloat('@ViewBag.MediumFuelConsumption.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)') || 0;

            var fuelSpended = (distanceCovered * mediumFuelConsumption) / 100;
            document.getElementById('changedFuelSpendede').value = fuelSpended.toFixed(3);
        });

        // Set initial value on page load
        window.onload = function () {
            var distanceCovered = parseFloat(document.getElementById('changedDistanceCovered').value) || 0;
            var mediumFuelConsumption = parseFloat('@ViewBag.MediumFuelConsumption.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)') || 0;

            var initialFuelSpended = (distanceCovered * mediumFuelConsumption) / 100;
            document.getElementById('changedFuelSpendede').value = initialFuelSpended.toFixed(3);
        };
    </script>
}